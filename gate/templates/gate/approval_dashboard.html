{% extends "gate/base.html" %}

{% block title %}Approval Dashboard | GateCheck{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    
    /* Custom Scrollbar for a cleaner look */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <div class="flex flex-col md:flex-row md:items-center md:justify-between border-b border-gray-200 pb-6 mb-8 gap-4">
        <div>
            <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight">
                üîê Approval Center
            </h2>
            <p class="mt-2 text-slate-500">Manage student movement requests efficiently.</p>
        </div>
        <div class="flex gap-2">
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-sky-100 text-sky-700 border border-sky-200">
                <span class="w-2 h-2 rounded-full bg-sky-500"></span> Outpass
            </span>
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700 border border-purple-200">
                <span class="w-2 h-2 rounded-full bg-purple-500"></span> Leave
            </span>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-5 sm:grid-cols-3 mb-10">
        <div class="relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-900/5 hover:shadow-md transition-all group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Pending Review</p>
                    <p class="mt-2 text-4xl font-bold text-slate-900">{{ pending_count }}</p>
                </div>
                <div class="h-12 w-12 rounded-xl bg-amber-50 text-amber-500 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                    ‚è≥
                </div>
            </div>
            <div class="absolute bottom-0 left-0 h-1 w-full bg-amber-400"></div>
        </div>

        <div class="relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-900/5 hover:shadow-md transition-all group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Total Approved</p>
                    <p class="mt-2 text-4xl font-bold text-slate-900">{{ approved_count }}</p>
                </div>
                <div class="h-12 w-12 rounded-xl bg-emerald-50 text-emerald-500 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                    ‚úÖ
                </div>
            </div>
            <div class="absolute bottom-0 left-0 h-1 w-full bg-emerald-500"></div>
        </div>

        <div class="relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-900/5 hover:shadow-md transition-all group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Total Rejected</p>
                    <p class="mt-2 text-4xl font-bold text-slate-900">{{ rejected_count }}</p>
                </div>
                <div class="h-12 w-12 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                    ‚ùå
                </div>
            </div>
            <div class="absolute bottom-0 left-0 h-1 w-full bg-rose-500"></div>
        </div>
    </div>

    <div class="mb-8">
        <div class="sm:hidden">
            <label for="tabs" class="sr-only">Select a tab</label>
            <select id="tabs" name="tabs" class="block w-full rounded-xl border-slate-300 py-3 text-base focus:border-indigo-500 focus:ring-indigo-500 shadow-sm" onchange="location = this.value;">
                <option value="?status=pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                <option value="?status=approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                <option value="?status=rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                <option value="?status=all" {% if status_filter == 'all' %}selected{% endif %}>All Requests</option>
            </select>
        </div>
        
        <div class="hidden sm:block">
            <nav class="flex space-x-2 bg-white p-1 rounded-xl shadow-sm border border-slate-200 w-fit" aria-label="Tabs">
                {% with "bg-slate-900 text-white shadow" as active_class %}
                {% with "text-slate-600 hover:text-slate-900 hover:bg-slate-50" as inactive_class %}
                
                <a href="?status=pending" class="{% if status_filter == 'pending' %}{{ active_class }}{% else %}{{ inactive_class }}{% endif %} rounded-lg px-4 py-2.5 text-sm font-semibold transition-all duration-200">
                    ‚è≥ Pending
                </a>
                <a href="?status=approved" class="{% if status_filter == 'approved' %}{{ active_class }}{% else %}{{ inactive_class }}{% endif %} rounded-lg px-4 py-2.5 text-sm font-semibold transition-all duration-200">
                    ‚úÖ Approved
                </a>
                <a href="?status=rejected" class="{% if status_filter == 'rejected' %}{{ active_class }}{% else %}{{ inactive_class }}{% endif %} rounded-lg px-4 py-2.5 text-sm font-semibold transition-all duration-200">
                    ‚ùå Rejected
                </a>
                <a href="?status=all" class="{% if status_filter == 'all' %}{{ active_class }}{% else %}{{ inactive_class }}{% endif %} rounded-lg px-4 py-2.5 text-sm font-semibold transition-all duration-200">
                    üìã All
                </a>
                
                {% endwith %}
                {% endwith %}
            </nav>
        </div>
    </div>

    <div class="space-y-6">
        {% if requests %}
            {% for request in requests %}
            
            <div class="group relative bg-white rounded-2xl shadow-sm ring-1 ring-slate-900/5 transition-all duration-300 hover:shadow-lg hover:-translate-y-1 overflow-hidden
                {% if request.request_type == 'Outpass' %} border-l-8 border-l-sky-500
                {% else %} border-l-8 border-l-purple-500 {% endif %}">
                
                <div class="px-6 py-3 border-b flex justify-between items-center
                    {% if request.request_type == 'Outpass' %} bg-sky-50 border-sky-100
                    {% else %} bg-purple-50 border-purple-100 {% endif %}">
                    
                    <div class="flex items-center gap-2">
                        {% if request.request_type == 'Outpass' %}
                            <span class="text-xl">üé´</span>
                            <span class="font-bold text-sm tracking-wide uppercase text-sky-700">Outpass Request</span>
                        {% else %}
                            <span class="text-xl">üèñÔ∏è</span>
                            <span class="font-bold text-sm tracking-wide uppercase text-purple-700">Leave Request</span>
                        {% endif %}
                    </div>

                    <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-bold uppercase tracking-wide
                        {% if request.status == 'pending' %}bg-amber-100 text-amber-700 border border-amber-200
                        {% elif request.status == 'approved' %}bg-emerald-100 text-emerald-700 border border-emerald-200
                        {% else %}bg-rose-100 text-rose-700 border border-rose-200{% endif %}">
                        {% if request.status == 'pending' %}‚è≥ Pending
                        {% elif request.status == 'approved' %}‚úÖ Approved
                        {% else %}‚ùå Rejected{% endif %}
                    </span>
                </div>

                <div class="p-6">
                    <div class="flex flex-col lg:flex-row gap-6 justify-between">
                        
                        <div class="flex-1">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h3 class="text-xl font-bold text-slate-900 group-hover:text-indigo-600 transition-colors">
                                        {{ request.student.full_name }}
                                    </h3>
                                    <p class="text-sm text-slate-500 font-medium">{{ request.student.enrollment_number }}</p>
                                </div>
                            </div>

                            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-y-4 gap-x-8">
                                <div class="col-span-1 sm:col-span-3 md:col-span-3">
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Reason</p>
                                    <p class="text-slate-800 font-medium bg-slate-50 p-2 rounded-lg border border-slate-100">
                                        {{ request.reason }}
                                    </p>
                                </div>
                                
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Destination</p>
                                    <p class="text-slate-800 font-semibold flex items-center gap-1">
                                        üìç {{ request.destination }}
                                    </p>
                                </div>

                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Duration</p>
                                    <p class="text-slate-800 font-semibold">
                                        {{ request.from_date|date:"d M" }} ‚ûù {{ request.to_date|date:"d M" }}
                                    </p>
                                </div>

                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Hostel Info</p>
                                    <p class="text-slate-800 font-medium text-sm">
                                        {{ request.student.hostel_name|default:"-" }} / {{ request.student.room_number|default:"-" }}
                                    </p>
                                </div>

                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Student Phone</p>
                                    <p class="text-slate-800 font-medium text-sm">üìû {{ request.student.phone|default:"N/A" }}</p>
                                </div>

                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Guardian Phone</p>
                                    <p class="text-slate-800 font-medium text-sm">üõ°Ô∏è {{ request.student.emergency_phone|default:"N/A" }}</p>
                                </div>
                            </div>

                            {% if request.status == 'rejected' and request.rejection_reason %}
                            <div class="mt-5 rounded-xl bg-rose-50 p-4 border border-rose-200">
                                <h4 class="text-sm font-bold text-rose-800 flex items-center gap-2">
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    Rejection Reason
                                </h4>
                                <p class="mt-1 text-sm text-rose-700 pl-6">{{ request.rejection_reason }}</p>
                            </div>
                            {% endif %}
                        </div>

                        {% if request.status == 'pending' %}
                        <div class="flex lg:flex-col gap-3 justify-center border-t lg:border-t-0 lg:border-l border-slate-100 pt-4 lg:pt-0 lg:pl-6 min-w-[140px]">
                            
                            <form method="post" action="{% url 'approve_leave' request.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" class="w-full inline-flex justify-center items-center rounded-xl bg-emerald-600 px-4 py-3 text-sm font-bold text-white shadow-lg shadow-emerald-200 hover:bg-emerald-700 hover:shadow-xl hover:-translate-y-0.5 transition-all">
                                    Approve
                                </button>
                            </form>
                            
                            <button type="button" 
                                data-request-id="{{ request.id }}"
                                data-student-name="{{ request.student.full_name|escapejs }}"
                                onclick="openRejectModal(this)"
                                class="w-full inline-flex justify-center items-center rounded-xl bg-white px-4 py-3 text-sm font-bold text-rose-600 border-2 border-rose-100 hover:bg-rose-50 hover:border-rose-200 transition-all">
                                Reject
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="px-6 py-2 bg-slate-50 border-t border-slate-100 flex flex-wrap justify-between text-xs text-slate-400">
                    <span>Requested: {{ request.created_at|date:"M d, Y ‚Ä¢ h:i A" }}</span>
                    {% if request.approved_by %}
                        <span>Processed by: <span class="font-semibold text-slate-600">{{ request.approved_by.get_full_name|default:request.approved_by.username }}</span></span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

        {% else %}
            <div class="text-center py-24 bg-white rounded-3xl border-2 border-dashed border-slate-200">
                <div class="mx-auto h-16 w-16 bg-slate-50 rounded-full flex items-center justify-center text-3xl mb-4">üì≠</div>
                <h3 class="text-lg font-bold text-slate-900">No requests found</h3>
                <p class="text-slate-500 mt-1">
                    {% if status_filter == 'pending' %}Good job! You've cleared the queue.{% endif %}
                    {% if status_filter == 'approved' %}No approval history found.{% endif %}
                    {% if status_filter == 'rejected' %}No rejected requests.{% endif %}
                </p>
                {% if status_filter != 'all' %}
                <a href="?status=all" class="mt-4 inline-block text-sm font-bold text-indigo-600 hover:text-indigo-500 hover:underline">
                    View all history
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<div id="rejectModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-rose-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-rose-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg font-bold leading-6 text-slate-900" id="modal-title">Reject Request</h3>
                            <div class="mt-2">
                                <p class="text-sm text-slate-500">
                                    Are you sure you want to reject the request for <strong id="modalStudentName" class="text-slate-900"></strong>?
                                </p>
                                <form id="rejectForm" method="post" action="" class="mt-4">
                                    {% csrf_token %}
                                    <label for="rejectionReason" class="block text-sm font-bold text-slate-700 mb-1">Reason for Rejection</label>
                                    <textarea id="rejectionReason" name="rejection_reason" rows="3" class="block w-full rounded-xl border-0 py-2 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-rose-600 sm:text-sm sm:leading-6 bg-slate-50" placeholder="e.g. Parents denied permission..."></textarea>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-slate-100">
                    <button type="button" onclick="submitRejection()" class="inline-flex w-full justify-center rounded-xl bg-rose-600 px-4 py-2 text-sm font-bold text-white shadow-sm hover:bg-rose-500 sm:ml-3 sm:w-auto transition-colors">Confirm Rejection</button>
                    <button type="button" onclick="closeRejectModal()" class="mt-3 inline-flex w-full justify-center rounded-xl bg-white px-4 py-2 text-sm font-bold text-slate-700 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openRejectModal(button) {
        const requestId = button.getAttribute('data-request-id');
        const studentName = button.getAttribute('data-student-name');
        
        const modal = document.getElementById('rejectModal');
        const form = document.getElementById('rejectForm');
        const studentNameEl = document.getElementById('modalStudentName');
        
        // Dynamically set the form action URL
        form.action = "{% url 'reject_leave' 0 %}".replace('0', requestId);
        
        studentNameEl.textContent = studentName;
        modal.classList.remove('hidden');
    }

    function closeRejectModal() {
        const modal = document.getElementById('rejectModal');
        modal.classList.add('hidden');
        document.getElementById('rejectionReason').value = '';
    }

    function submitRejection() {
        document.getElementById('rejectForm').submit();
    }
</script>

{% endblock %}