{% extends "gate/base.html" %}

{% block title %}Gate Check | GateFlow{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto pb-12">

  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8 mt-4">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-slate-800 mb-1 tracking-tight">Gate Check-In</h1>
        <p class="text-slate-500 text-sm font-medium">Scan QR code or enter enrollment number.</p>
      </div>
      
      <a href="{% url 'add_student' %}" class="group flex items-center gap-2 px-4 py-2 bg-slate-50 text-slate-600 hover:text-violet-600 hover:bg-violet-50 border border-slate-200 hover:border-violet-200 rounded-lg transition-all font-bold text-sm">
        <div class="bg-white rounded-md p-1 shadow-sm border border-slate-100 group-hover:border-violet-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        </div>
        Add New Student
      </a>
    </div>

    <div class="w-full">
      <form method="post" class="relative group">
        {% csrf_token %}
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 group-focus-within:text-violet-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input type="text" 
               name="enrollment_number" 
               class="block w-full pl-12 pr-24 py-4 border-2 border-slate-200 rounded-xl leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:border-violet-500 focus:ring-4 focus:ring-violet-500/10 transition-all text-lg font-bold text-slate-800" 
               placeholder="Search Enrollment ID..." 
               autofocus 
               required>
        <button type="submit" class="absolute inset-y-2 right-2 px-6 bg-slate-900 text-white font-bold rounded-lg hover:bg-violet-600 transition-colors shadow-md flex items-center gap-2">
          Search
        </button>
      </form>
    </div>
  </div>

  {% if searched and results %}
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8 animate-fade-in-up">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
      <h3 class="font-bold text-slate-700 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
        Matching Students
      </h3>
      <span class="bg-violet-100 text-violet-700 text-xs font-bold px-3 py-1 rounded-full">{{ results|length }} Found</span>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-100">
        <thead class="bg-slate-50/50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Enrollment</th>
            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Name</th>
            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Hostel</th>
            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-right"></th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-100">
          {% for s in results %}
          <tr class="hover:bg-violet-50/50 transition-colors group cursor-pointer" onclick="window.location='?enr={{ s.enrollment_number|urlencode }}'">
            <td class="px-6 py-4 whitespace-nowrap font-mono text-sm font-semibold text-slate-600">{{ s.enrollment_number }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-800">{{ s.full_name }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{{ s.hostel_name|default:"-" }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if s.is_inside %}
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700 border border-emerald-200">
                  <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span> INSIDE
                </span>
              {% else %}
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-rose-100 text-rose-700 border border-rose-200">
                  <span class="h-1.5 w-1.5 rounded-full bg-rose-500"></span> OUTSIDE
                </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
              <a href="?enr={{ s.enrollment_number|urlencode }}" class="text-violet-600 font-bold text-sm hover:underline group-hover:text-violet-700">Select →</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}


  {% if searched and student %}
  <div class="animate-fade-in-up">
    
    <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-200 flex flex-col md:flex-row">
      
      <div class="md:w-1/3 bg-slate-50 p-8 flex flex-col items-center justify-center border-r border-slate-100 relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-2 {% if student.is_inside %}bg-emerald-500{% else %}bg-rose-500{% endif %}"></div>
        
        <div class="relative h-48 w-48 mb-6 group">
          <div class="absolute inset-0 rounded-full border-4 opacity-30 animate-pulse {% if student.is_inside %}border-emerald-400{% else %}border-rose-400{% endif %}"></div>
          
          <div class="h-full w-full rounded-full border-4 border-white shadow-xl overflow-hidden bg-white z-10 relative">
            {% if student.photo %}
              <img src="{{ student.photo.url }}" alt="{{ student.full_name }}" class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110">
            {% else %}
              <div class="h-full w-full flex items-center justify-center bg-slate-200 text-slate-400 text-4xl font-bold">
                {{ student.full_name|slice:":1" }}
              </div>
            {% endif %}
          </div>
          
          <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 px-4 py-1.5 rounded-full text-sm font-extrabold shadow-lg border-2 border-white tracking-wide whitespace-nowrap z-20
            {% if student.is_inside %}bg-emerald-500 text-white{% else %}bg-rose-500 text-white{% endif %}">
            {% if student.is_inside %}ON CAMPUS{% else %}OFF CAMPUS{% endif %}
          </div>
        </div>

        <div class="text-center mt-2">
          <h2 class="text-xl font-extrabold text-slate-800">{{ student.full_name }}</h2>
          <p class="font-mono text-slate-500 font-semibold bg-slate-200/50 px-2 py-0.5 rounded text-sm inline-block mt-1">{{ student.enrollment_number }}</p>
        </div>
      </div>

      <div class="md:w-2/3 p-8 flex flex-col justify-between">
        
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-100 hover:border-violet-100 transition-colors">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Course / Year</p>
            <p class="text-sm font-bold text-slate-700">{{ student.course }} • {{ student.year }} Yr</p>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-100 hover:border-violet-100 transition-colors">
             <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Hostel</p>
             <p class="text-sm font-bold text-slate-700">{{ student.hostel_name|default:"-" }} / {{ student.room_number|default:"-" }}</p>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-100 hover:border-violet-100 transition-colors">
             <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Phone</p>
             <p class="text-sm font-bold text-slate-700">{{ student.phone|default:"N/A" }}</p>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-100 hover:border-violet-100 transition-colors">
             <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Emergency</p>
             <p class="text-sm font-bold text-slate-700">{{ student.emergency_phone|default:"N/A" }}</p>
          </div>
        </div>

        {% if active_leave %}
        <div class="mb-6 bg-emerald-50 border border-emerald-200 rounded-xl p-4 flex gap-4 items-start shadow-sm">
           <div class="bg-emerald-100 p-2.5 rounded-lg text-emerald-600 shrink-0">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
           </div>
           <div>
             <h4 class="font-bold text-emerald-900 text-lg leading-tight">Approved {{ active_leave.request_type }} Active</h4>
             <p class="text-sm text-emerald-700 mt-1">
               Valid until <span class="font-bold">{{ active_leave.to_date|date:"h:i A" }}</span> today.<br>
               Destination: {{ active_leave.destination }}
             </p>
           </div>
        </div>
        {% elif student.is_inside %}
          <div class="mb-6 bg-amber-50 border border-amber-200 rounded-xl p-4 flex gap-3 items-center">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
             <p class="text-sm font-bold text-amber-800">No active leave request found for today.</p>
          </div>
        {% endif %}

        <form method="post" action="{% url 'gate_toggle' %}" class="mt-auto">
          {% csrf_token %}
          <input type="hidden" name="enrollment_number" value="{{ student.enrollment_number }}">
          
          <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Guard Note (Optional)</label>
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" name="note" class="flex-1 rounded-xl border border-slate-300 px-4 py-3 focus:border-violet-500 focus:ring-violet-500 focus:outline-none bg-slate-50" placeholder="Reason for manual entry...">
            
            {% if student.is_inside %}
              <button type="submit" class="sm:w-48 w-full bg-rose-600 hover:bg-rose-700 text-white font-extrabold rounded-xl shadow-lg shadow-rose-200 hover:shadow-xl transition-all flex items-center justify-center gap-2 py-3 sm:py-0">
                <span>RECORD EXIT</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
              </button>
            {% else %}
              <button type="submit" class="sm:w-48 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold rounded-xl shadow-lg shadow-emerald-200 hover:shadow-xl transition-all flex items-center justify-center gap-2 py-3 sm:py-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" transform="rotate(180 10 10)"/></svg>
                <span>ALLOW ENTRY</span>
              </button>
            {% endif %}
          </div>
        </form>

      </div>
    </div>
  </div>
  {% endif %}

  <div class="mt-8 flex justify-center gap-4 text-sm font-medium text-slate-400">
    <a href="{% url 'home' %}" class="hover:text-violet-600 transition-colors">Return to Dashboard</a>
  </div>

</div>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}